---
title: "Baseline Characteristics NOVELTY vs. EPIC"
format: 
  html:
    toc: true
    code-fold: true
    theme: cosmo
    self-contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(knitr)
```

------------------------------------------------------------------------

## 1. Process EPIC Simulation Data

The EPIC simulation (`epic_selected`) outputted from the Copula model are standardized into numeric formats (0/1 for binary and categorical, continuous for others) to facilitate statistical comparison."

```{r}

# ==============================================================================
#  DATA PREPARATION FOR ANALYSIS
# ==============================================================================
#   - Load the final cohort of simulated patients selected by the Copula model.
#   - Standardize the data to calculate the Standardized Mean Difference (SMD).
#   - Transform categorical variables and binary variables to 0 or 1 values.
#
# 
#   For example to calculate the percentage of a category (like "GOLD 1"), it has to 
#   be first converted into a numeric format where 1 = Yes and 0 = No.
#
#   Example:
#   If we have a group of 10 people where 4 are GOLD 1 (coded as 1) and 6 are 
#   not GOLD 1 (coded as 0), summing the column gives us 4. Calculating the 
#   mean (4 / 10) results in 0.40, which confirms that 40% of the 
#   group are GOLD 1.
#      
#      

# Load simulation data
if (file.exists("epic_selected.rds")) {
  epic_selected <- readRDS("epic_selected.rds")
} else {
  stop("ERROR: Could not find epic_selected.rds")
}

# Transform data 
# Create a clean table ('epic_baseline') of variables for Table 1.
epic_baseline <- epic_selected %>%
  transmute(
    # --- Binary variables (Yes/No) ---
    # Convert gender to a number: 1 = Female, 0 = Male
    Female = case_when(
      grepl("Female", as.character(female), ignore.case = TRUE) ~ 1,
      as.character(female) == "1" ~ 1,
      TRUE ~ 0
    ),
    
    # Convert mMRC to a number: 1 = Yes (Score > 0), 0 = No
    `mMRC (>0)` = case_when(
      grepl("Yes", as.character(dyspnea), ignore.case = TRUE) ~ 1,
      as.character(dyspnea) == "1" ~ 1,
      TRUE ~ 0
    ),
    
    # --- Continuous variables averages ---
    # Ensure these are treated as numbers to calculate mean and SD.
    Age = as.numeric(age_at_COPD),
    `Moderate Exacerbation` = as.numeric(as.character(exac_history_n_moderate)),
    `Severe Exacerbation`   = as.numeric(as.character(exac_history_n_severe_plus)),
    
    # --- Categorical variables  ---
    # First convert it to a simple number (1, 2, 3, 4).
    gold_num = case_when(
      grepl("1", as.character(gold)) ~ 1,
      grepl("2", as.character(gold)) ~ 2,
      grepl("3", as.character(gold)) ~ 3,
      grepl("4", as.character(gold)) ~ 4,
      TRUE ~ NA_real_
    ),
    
    # Same for smoking: Convert "Current", "Former", "Never" into 0, 1, 2.
    smoke_num = case_when(
      grepl("Never", as.character(smoking_status), ignore.case = TRUE) ~ 0,
      grepl("Current", as.character(smoking_status), ignore.case = TRUE) ~ 1,
      grepl("Former", as.character(smoking_status), ignore.case = TRUE) ~ 2,
      as.character(smoking_status) == "0" ~ 0,
      as.character(smoking_status) == "1" ~ 1,
      as.character(smoking_status) == "2" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  
  #    Create the binary encoding
  #    Here we split the categories into specific Yes/No columns.
  #    Example: If a patient is GOLD 1, the 'GOLD 1' column gets a 1, and patients without 'GOLD 1' gets a 0.
  mutate(
    `GOLD 1` = as.integer(gold_num == 1),
    `GOLD 2` = as.integer(gold_num == 2),
    `GOLD 3` = as.integer(gold_num == 3),
    `GOLD 4` = as.integer(gold_num == 4),
    
    `Never Smoker`   = as.integer(smoke_num == 0),
    `Current Smoker` = as.integer(smoke_num == 1),
    `Former Smoker`  = as.integer(smoke_num == 2)
  )
```

## 2. Generate Table 1 and Determine **Standardized Mean Difference**

Baseline characteristics are presented, reporting the Mean (SD) for continuous variables and counts with percentages for binary and categorical variables. The Standardized Mean Difference (SMD) is calculated to assess balance. For binary and categorical variables, SMDs are calculated by treating the variable as a binary (0/1) indicator, where the standard deviation is derived from the proportion.

```{r}

# ==============================================================================
#  STATISTICAL COMPARISON (SMD CALCULATION)
# ==============================================================================

# Define NOVELTY Baseline
novelty_baseline <- tibble::tribble(
  ~Variable,                ~Type,         ~NOV_Mean, ~NOV_SD_Reported,
  "Age",                    "continuous",  63.7,      9.7,
  "Female",                 "binary",      0.482,     NA,
  "GOLD 1",                 "binary",      0.219,     NA,
  "GOLD 2",                 "binary",      0.473,     NA,
  "GOLD 3",                 "binary",      0.234,     NA,
  "GOLD 4",                 "binary",      0.074,     NA,
  "Never Smoker",           "binary",      0.091,     NA,
  "Current Smoker",         "binary",      0.410,     NA,
  "Former Smoker",          "binary",      0.498,     NA,
  "Moderate Exacerbation",  "continuous",  0.22,      0.59,
  "Severe Exacerbation",    "continuous",  0.17,      0.47,
  "mMRC (>0)",              "binary",      0.853,     NA
) %>%
  mutate(
    # Calculate SD for binary variables using sqrt(p * (1-p))
    NOV_SD = if_else(Type == "binary", sqrt(NOV_Mean * (1 - NOV_Mean)), NOV_SD_Reported)
  )

# Calculate EPIC Cohort Stats
epic_stats <- epic_baseline %>%
  summarise(across(everything(), list(
    Mean = ~mean(., na.rm = TRUE),
    SD   = ~sd(., na.rm = TRUE)
  ))) %>%
  pivot_longer(
    cols = everything(), 
    names_to = c("Variable", ".value"), 
    names_pattern = "(.*)_(.*)"
  ) %>%
  rename(EPIC_Mean = Mean, EPIC_SD = SD)

# Join and Calculate SMD
epic_novelty_calc<- novelty_baseline %>%
  left_join(epic_stats, by = "Variable") %>%
  mutate(
    # Correct SD for EPIC binary variables
    EPIC_SD = if_else(Type == "binary", sqrt(EPIC_Mean * (1 - EPIC_Mean)), EPIC_SD),
    
    # Calculate Pooled SD
    Pooled_SD = sqrt((EPIC_SD^2 + NOV_SD^2) / 2),
    
    # Calculate SMD
    SMD = if_else(Pooled_SD == 0, 0, abs(EPIC_Mean - NOV_Mean) / Pooled_SD)
  )

# Format for Display with Traffic Light
epic_novelty_baseline<- epic_novelty_calc %>%
  mutate(
    `NOVELTY` = case_when(
      Type == "continuous" ~ sprintf("%.2f (%.2f)", NOV_Mean, NOV_SD),
      Type == "binary"     ~ sprintf("%.2f%%", NOV_Mean * 100)
    ),
    `EPIC` = case_when(
      Type == "continuous" ~ sprintf("%.2f (%.2f)", EPIC_Mean, EPIC_SD),
      Type == "binary"     ~ sprintf("%.2f%%", EPIC_Mean * 100)
    ),
    # --- Traffic Light Logic ---
    Status = if_else(SMD < 0.1, "ðŸŸ¢ Balanced", "ðŸ”´ Imbalanced"),
    SMD = sprintf("%.3f", SMD)
  ) %>%
  select(Variable, `NOVELTY`, `EPIC`, SMD, Status)

# Print table
kable(epic_novelty_baseline, caption = "Table 1: Comparison of NOVELTY vs. EPIC Cohort")

```

## 3. Visual Comparison

Below is a visualization of the Standardized Mean Differences (SMD) for the baseline characteristics. The red dashed line at **0.1** represents the SMD threshold representing a balanced comparative cohort.

```{r}
plot_data <- epic_novelty_calc

# Generate Plot
ggplot(plot_data, aes(x = SMD, y = reorder(Variable, SMD))) + 
  # Set a single static color here (e.g., "#2c3e50" is a nice dark blue-grey)
  geom_point(size = 4, color = "#2c3e50") + 
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_vline(xintercept = 0, color = "black") +
  labs(
    title = "EPIC vs NOVELTY",
    subtitle = "Standardized Mean Difference",
    x = "Absolute SMD",
    y = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title    = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )
  
```
